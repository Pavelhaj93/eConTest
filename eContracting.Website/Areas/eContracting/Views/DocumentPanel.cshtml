@using Glass.Mapper.Sc.Web.Mvc
@using eContracting.Kernel.GlassItems.Content.Modal_window
@using eContracting.Kernel.GlassItems.RenderingParameters.Modal_window
@using eContracting.Kernel.Models
@using Sitecore.Data.Items

@model MW01DataSource

<!-- Latest compiled and minified JavaScript -->
<script src="~/Assets/eContracting/js/bootstrap.min.js"></script>
<link href="~/Assets/eContracting/css/popup.css" rel="stylesheet" />
@if (Model.IsRetention)
{
    <script src="~/Assets/eContracting/js/vendor/jSignature.min.js"></script>
}
<div class="row">
    <div class="col-sm-12 col-md-10 col-md-offset-1">
        @if (Model.IsRetention)
        {
            if (Model.IsAccepted)
            {
                <h2>@ViewData["DocumentToSignAccepted"]</h2>
            }
            else
            {
                <h2>@ViewData["DocumentToSign"]</h2>
            }
        }
        <div class="form-background">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12 col-md-10 col-md-offset-1">
                        @using (Html.BeginForm("Accept", "eContracting", FormMethod.Post, new { id = "offer", @class = Model.IsRetention ? "form loading" : "form" }))
                        {
                            @Html.AntiForgeryToken()
                            if (!Model.IsRetention && !Model.IsAcquisition)
                            {
                                <ul class="list list-documents loading">
                                    <a class="check-all" href="#">@ViewData["SelectAll_Text"]</a>
                                </ul>
                            }
                            else
                            {
                                <div class="steps">
                                    <div class="step">
                                        <div class="step__heading">
                                            <h3>@ViewData["Step1Heading"]</h3>
                                            <span class="step__icon" aria-hidden="true">
                                                <svg class="icon" preserveAspectRatio="none">
                                                    <use xlink:href="~/Assets/eContracting/gfx/icon/svg.svg#number-one-circle"></use>
                                                </svg>
                                            </span>
                                            <span class="step__icon" aria-hidden="true">
                                                <svg class="icon" preserveAspectRatio="none">
                                                    <use xlink:href="~/Assets/eContracting/gfx/icon/svg.svg#check-circle"></use>
                                                </svg>
                                            </span>
                                        </div>
                                        <ul class="list list-documents js-list-general-documents">
                                            <a class="check-all" href="#">@ViewData["SelectAll_Text"]</a>
                                        </ul>
                                    </div>
                                    <div class="step">
                                        <div class="step__heading">
                                            <h3>@ViewData["Step2Heading"]</h3>
                                            <span class="step__icon" aria-hidden="true">
                                                <svg class="icon" preserveAspectRatio="none">
                                                    <use xlink:href="~/Assets/eContracting/gfx/icon/svg.svg#number-two-circle"></use>
                                                </svg>
                                            </span>
                                            <span class="step__icon" aria-hidden="true">
                                                <svg class="icon" preserveAspectRatio="none">
                                                    <use xlink:href="~/Assets/eContracting/gfx/icon/svg.svg#check-circle"></use>
                                                </svg>
                                            </span>
                                        </div>
                                        @if (!Model.IsAccepted)
                                        {
                                            <p class="text-muted">@ViewData["WhySignIsRequired"]</p>
                                        }
                                        <ul class="list list-documents list-documents-to-be-signed"></ul>
                                        @if (!Model.IsAccepted)
                                        {
                                            <button type="button" class="btn btn-primary mt-0 js-signature-btn" data-target="#modalSign">@ViewData["SignButton"]</button>
                                            <p class="small text-muted mt-1">@ViewData["HowToSign"]</p>
                                        }
                                    </div>
                                </div>
                            }
                            if (Model.IsRetention || Model.IsAcquisition)
                            {
                                <div class="submit-zone">
                                    <p>@ViewData["HowToAccept"]</p>
                                    <button type="button" class="button button-submit">@ViewData["Accept"]</button>
                                </div>
                            }
                            else
                            {
                                <button type="button" class="button button-submit">@ViewData["Accept"]</button>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="modalConfirmYesNo" class="modal fade in" tabindex="-1" role="dialog" aria-labelledby="modalFormGeneral" style="display: none; padding-right: 15px;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
                <h4 class="modal-title">@Html.Sitecore().Field("Title", Model.Item)</h4>
            </div>
            <div class="modal-body">@Html.Sitecore().Field("Text", Model.Item)</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" id="btnNoConfirmYesNo">
                    @Html.Sitecore().Field("Cancel_Text", Model.Item)
                </button>
                <button type="button" class="btn btn-primary" data-submit="#modalConfirmYesNo" id="btnYesConfirmYesNo">
                    @Html.Sitecore().Field("Accept_Text", Model.Item)
                </button>
            </div>
        </div>
    </div>
</div>

@if (Model.IsRetention)
{
    <div id="modalSign" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&#215;</span>
                    </button>
                    <h4 class="modal-title">@ViewData["SignDocument"]</h4>
                </div>
                <div class="modal-body">
                    <div class="document-wrapper"></div>
                    <p>@ViewData["SignRequest"]</p>
                    <div id="signature" class="signature js-signature"></div>
                    <p class="small text-muted mt-1">@ViewData["HowToSign"]</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary js-signature-save-btn">@ViewData["SignConfirm"]</button>
                    <button type="button" class="btn btn-default js-signature-clear-btn">@ViewData["SignDelete"]</button>
                </div>
            </div>
        </div>
    </div>
}

<script>
    var offerPageOptions = {
        doxReadyUrl: '@Url.Content("~/Areas/eContracting/Services/DoxReady.ashx?id")=@Model.ClientId',
        isAgreed: @Model.IsAccepted.ToString().ToLower(),
        isRetention: @Model.IsRetention.ToString().ToLower(),
        getFileUrl: '@Url.Content("~/Areas/eContracting/Services/GetFile.ashx?file=")',
        getFileForSignUrl: '@Url.Content("~/Areas/eContracting/Services/GetFileImage.ashx?file=")',
        signFileUrl: '@Url.Content("~/Areas/eContracting/Services/SignFile.ashx?file=")'
    }

    $("#offer").ready(function () {
        $("#offer .button-submit").click(function (event) {
            event.preventDefault();
            var $confirm = $("#modalConfirmYesNo");
            var $form = $("#offer");
            $confirm.modal('show');
            $("#btnYesConfirmYesNo").off('click').click(function () {
                $form.submit();
                $confirm.modal("hide");
            });
            $("#btnNoConfirmYesNo").off('click').click(function () {
                $confirm.modal("hide");
            });
        });
    });
</script>
